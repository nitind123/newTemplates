name: Validate JFrog Artifacts (Alternative)

on:
  push:
    branches:
      - main

jobs:
  validate-artifacts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
      
      # Alternative: Use official JFrog setup action (more reliable)
      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v3
        with:
          version: latest

      - name: Configure JFrog CLI
        env:
          JFROG_URL: ${{ secrets.JFROG_URL }}
          JFROG_ACCESS_TOKEN: ${{ secrets.JFROG_ACCESS_TOKEN }}
        run: |
          # Use --access-token instead of --user/--password for token authentication
          jf c add productdemo \
            --interactive=false \
            --url="$JFROG_URL" \
            --access-token="$JFROG_ACCESS_TOKEN"
          
          # Verify configuration
          echo "Verifying JFrog configuration..."
          jf c show productdemo || echo "Configuration failed"
          
          # Test connectivity
          echo "Testing Artifactory connectivity..."
          jf rt ping --server-id productdemo || echo "Ping failed"

      - name: Search for Artifact in JFrog
        id: artifactory_search
        env:
          ARTIFACT_NAME: "2025_48913_aug-25_09-32_applicable_092ca"
        run: |
          echo "Searching for artifact: $ARTIFACT_NAME"
          
          # Try multiple search patterns for Docker images
          echo "=== Pattern 1: Search for any matching artifacts ==="
          result1=$(jf rt s "docker-local/*${ARTIFACT_NAME}*" --server-id productdemo --limit=10 || echo "No results")
          echo "$result1"
          
          echo "=== Pattern 2: Search for manifest files ==="
          result2=$(jf rt s "docker-local/*${ARTIFACT_NAME}*/*/manifest.json" --server-id productdemo --limit=10 || echo "No results")
          echo "$result2"
          
          echo "=== Pattern 3: Search for list.manifest.json files ==="
          result3=$(jf rt s "docker-local/*${ARTIFACT_NAME}*/*/list.manifest.json" --server-id productdemo --limit=10 || echo "No results")
          echo "$result3"
          
          echo "=== Pattern 4: Search with latest tag ==="
          result4=$(jf rt s "docker-local/*${ARTIFACT_NAME}*/latest/*" --server-id productdemo --limit=10 || echo "No results")
          echo "$result4"
          
          # Check if any results were found
          if echo "$result1" | grep -q "path"; then
            echo "Artifact found!"
            echo "artifact_found=true" >> $GITHUB_OUTPUT
            echo "artifact_path=$(echo "$result1" | jq -r '.[0].path' | head -1)" >> $GITHUB_OUTPUT
          else
            echo "Artifact not found with any pattern"
            echo "artifact_found=false" >> $GITHUB_OUTPUT
            
            # List some artifacts in docker-local to help debug
            echo "=== Listing sample artifacts in docker-local ==="
            SEARCH_RESULT=$(jf rt s "docker-local/*" --server-id productdemo --limit=5 || echo "Could not list artifacts") || true
          fi

          
          # Extract artifact details
          echo "=== xtract artifact details ==="
          ARTIFACT_PATH=$(echo "$result4" | jq -r '.[0].path // empty' 2>/dev/null)
          ARTIFACT_SHA256=$(echo "$result4" | jq -r '.[0].sha256 // empty' 2>/dev/null)
          ARTIFACT_MD5=$(echo "$result4" | jq -r '.[0].md5 // empty' 2>/dev/null)

          echo "$ARTIFACT_PATH"
          echo "$result1" | grep -q "path"
          
          if [ -z "$ARTIFACT_PATH" ]; then
            echo "‚ùå Could not extract artifact path from search results"
            echo "Search result: $ARTIFACT_PATH"
            echo "Search result: $ARTIFACT_SHA256"
            exit 1
          fi

      - name: Create Artifact Deployment Record
        if: steps.artifactory_search.outputs.artifact_found == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Artifact found at: ${{ steps.artifactory_search.outputs.artifact_path }}"
          # Your deployment record creation logic here


